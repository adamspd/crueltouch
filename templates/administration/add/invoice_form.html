{% extends 'administration/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block customCSS %}
    <style>
        /* Autocomplete Dropdown */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }

        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .autocomplete-item:hover {
            background: #f3f4f6;
        }

        /* Formset Styling */
        .formset-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 40px;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            background: white;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .delete-check {
            transform: scale(1.5);
        }
    </style>
{% endblock %}

{% block body %}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">{{ title }}</h3>
        </div>

        <div class="card-body" style="padding: 2rem;">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <h4 style="margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">Client
                    Details</h4>
                <div class="form-grid">
                    <div class="form-row">
                        <div class="form-group autocomplete-wrapper">
                            <label>Email *</label>
                            {{ form.client_email }}
                            <div id="autocomplete-results" class="autocomplete-results" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            {{ form.client_phone }}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name</label>
                            {{ form.client_first_name }}
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            {{ form.client_last_name }}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        {{ form.client_address }}
                    </div>
                </div>

                <h4 style="margin: 2rem 0 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">Invoice
                    Details</h4>
                <div class="form-row">
                    <div class="form-group"><label>Status</label>{{ form.status }}</div>
                    <div class="form-group"><label>Due Date</label>{{ form.due_date }}</div>
                    <div class="form-group"><label>Payment Method</label>{{ form.payment_method }}</div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Discount %</label>{{ form.discount }}</div>
                    <div class="form-group"><label>Tax Rate %</label>{{ form.tax_rate }}</div>
                    <div class="form-group"><label>Amount Paid</label>{{ form.amount_paid }}</div>
                </div>

                <h4 style="margin: 2rem 0 1rem;">Services</h4>
                {{ service_formset.management_form }}
                <div id="services-container">
                    {% for form in service_formset %}
                        <div class="formset-row service-row">
                            {{ form.id }}
                            <div>{{ form.service_name }}</div>
                            <div>{{ form.service_price }}</div>
                            <div>{{ form.service_quantity }}</div>
                            <div title="Delete?">{{ form.DELETE }}</div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-secondary btn-sm" id="add-service">
                    <i class="fas fa-plus"></i> Add Service
                </button>

                <h4 style="margin: 2rem 0 1rem;">Attachments</h4>
                {{ attachment_formset.management_form }}
                <div id="attachments-container">
                    {% for form in attachment_formset %}
                        <div class="formset-row attachment-row" style="grid-template-columns: 1fr 40px;">
                            {{ form.id }}
                            <div>{{ form.file }}</div>
                            <div>{{ form.DELETE }}</div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-secondary btn-sm" id="add-attachment">
                    <i class="fas fa-paperclip"></i> Add File
                </button>

                <div style="margin-top: 3rem; display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">Save Invoice</button>
                    <a href="{% url 'administration:list_invoices' %}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block customJS %}
    <script>
        // --- 1. Autocomplete Logic ---
        const emailInput = document.getElementById('id_client_email');
        const resultsBox = document.getElementById('autocomplete-results');

        emailInput.addEventListener('input', async function () {
            const query = this.value;
            const url = this.dataset.ajaxUrl; // Pulled from data attribute

            if (query.length < 2) {
                resultsBox.style.display = 'none';
                return;
            }

            try {
                const res = await fetch(`${url}?term=${query}`);
                const data = await res.json();

                resultsBox.innerHTML = '';
                if (data.length > 0) {
                    resultsBox.style.display = 'block';
                    data.forEach(client => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-item';
                        div.textContent = `${client.email} (${client.first_name})`;
                        div.onclick = () => {
                            // Populate Fields
                            emailInput.value = client.email;
                            document.getElementById('id_client_first_name').value = client.first_name || '';
                            document.getElementById('id_client_last_name').value = client.last_name || '';
                            document.getElementById('id_client_phone').value = client.phone || '';
                            document.getElementById('id_client_address').value = client.address || '';
                            resultsBox.style.display = 'none';
                        };
                        resultsBox.appendChild(div);
                    });
                } else {
                    resultsBox.style.display = 'none';
                }
            } catch (err) {
                console.error(err);
            }
        });

        // Close on click outside
        document.addEventListener('click', (e) => {
            if (!emailInput.contains(e.target) && !resultsBox.contains(e.target)) {
                resultsBox.style.display = 'none';
            }
        });

        // --- 2. Dynamic Formset Logic ---
        function setupFormset(btnId, containerId, prefix) {
            const btn = document.getElementById(btnId);
            const container = document.getElementById(containerId);
            const totalForms = document.getElementById(`id_${prefix}-TOTAL_FORMS`);

            btn.addEventListener('click', () => {
                const count = parseInt(totalForms.value);
                const forms = container.querySelectorAll('.formset-row');
                const lastForm = forms[forms.length - 1];

                // Clone the last form
                const newForm = lastForm.cloneNode(true);

                // Regex to update IDs/Names: name="services-0-service_name" -> "services-1-service_name"
                const regex = new RegExp(`(${prefix}-(\\d+)-)`, 'g');
                newForm.innerHTML = newForm.innerHTML.replace(regex, `${prefix}-${count}-`);

                // Clear values
                newForm.querySelectorAll('input').forEach(input => {
                    if (input.type !== 'hidden' && input.type !== 'checkbox') input.value = '';
                    if (input.type === 'checkbox') input.checked = false;
                });

                container.appendChild(newForm);
                totalForms.value = count + 1;
            });
        }

        setupFormset('add-service', 'services-container', 'services');
        setupFormset('add-attachment', 'attachments-container', 'attachments');
    </script>
{% endblock %}
