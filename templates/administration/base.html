{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}TCHIIZ | Admin{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

    <link rel="stylesheet" href="{% static 'administration/css/admin.css' %}">

    {% block customCSS %}{% endblock %}
</head>
<body>

<div class="tchiiz-layout">

    <aside class="tchiiz-sidebar" id="sidebar">
        <!-- Brand -->
        <a href="{% url 'homepage:index' %}" class="tchiiz-brand">
            <div class="tchiiz-brand-logo">
                <img src="{% static 'homepage/img/icon/android-icon-48x48.png' %}" alt="Logo">
            </div>
            <div class="tchiiz-brand-text">
                <span class="tchiiz-brand-name">TCHIIZ</span>
                <span class="tchiiz-brand-tagline">Studio</span>
            </div>
        </a>

        <!-- User Profile Power Center -->
        <div class="tchiiz-user-profile" onclick="toggleUserProfile(this)">
            <div class="tchiiz-user-avatar">
                {% if user.profile_photo and user.profile_photo.file %}
                    <img src="{{ user.profile_photo.file.url }}" alt="Profile">
                {% else %}
                    <div class="tchiiz-avatar-placeholder">
                        {{ user.first_name|slice:":1"|default:"U" }}
                    </div>
                {% endif %}
                <div class="tchiiz-user-status"></div>
            </div>
            <div class="tchiiz-user-info">
                <div class="tchiiz-user-name">
                    {% if user.first_name %}{{ user.get_full_name }}{% else %}{{ user.email }}{% endif %}
                </div>
                <div class="tchiiz-user-role">Administrator</div>
            </div>
            <i class="fas fa-chevron-down tchiiz-profile-toggle"></i>
        </div>

        <!-- Expandable User Quick Stats -->
        <div class="tchiiz-user-stats">
            <div class="tchiiz-stat-item">
                <span class="value">{{ total_request_session|default:"0" }}</span>
                <span class="label">Appointments</span>
            </div>
            <div class="tchiiz-stat-item">
                <span class="value">{{ total_contact_forms|default:"0" }}</span>
                <span class="label">Messages</span>
            </div>
            <div class="tchiiz-stat-item">
                <span class="value">{{ total_clients|default:"0" }}</span>
                <span class="label">Clients</span>
            </div>
        </div>

        <!-- Quick Action Button -->
        <div class="tchiiz-quick-action">
            <a href="{% url 'appointment:get_user_appointments' %}" class="tchiiz-btn-primary">
                <i class="fas fa-plus"></i> New Appointment
            </a>
        </div>

        <!-- Navigation -->
        <nav class="tchiiz-nav">
            <!-- Dashboard - Always prominent -->
            <a href="{% url 'administration:index' %}"
               class="tchiiz-nav-item {% if request.resolver_match.url_name == 'index' %}active{% endif %}">
                <i class="fas fa-tachometer-alt"></i>
                <span>{% translate "Dashboard" %}</span>
            </a>

            {% if user.email == "adamspierredavid@gmail.com" %}
                <a href="/admin" class="tchiiz-nav-item tchiiz-nav-danger" target="_blank">
                    <i class="fas fa-lock"></i>
                    <span>{% translate "Django Admin" %}</span>
                </a>
            {% endif %}

            <div class="tchiiz-nav-divider"></div>

            <!-- Core Functions -->
            <div class="tchiiz-nav-section">
                <div class="tchiiz-nav-item has-treeview" onclick="toggleSubmenu(this)">
                    <i class="fas fa-calendar"></i>
                    <span>{% translate "Appointment" %}</span>
                    <i class="fas fa-chevron-right tchiiz-submenu-arrow"></i>
                </div>
                <div class="tchiiz-nav-treeview">
                    <a href="{% url 'appointment:get_user_appointments' %}"
                       class="tchiiz-nav-item {% if request.resolver_match.url_name == 'get_user_appointments' %}active{% endif %}">
                        <i class="far fa-eye"></i>
                        <span>{% translate "View all" %}</span>
                    </a>
                    <a href="{% url 'appointment:user_profile' user.id %}"
                       class="tchiiz-nav-item {% if request.resolver_match.url_name == 'user_profile' %}active{% endif %}">
                        <i class="far fa-user-circle"></i>
                        <span>{% translate "User Profile" %}</span>
                    </a>
                    {% if user.is_superuser %}
                        <a href="{% url 'appointment:add_service' %}"
                           class="tchiiz-nav-item {% if request.resolver_match.url_name == 'add_service' %}active{% endif %}">
                            <i class="far fa-plus-square"></i>
                            <span>{% translate "Add Service" %}</span>
                        </a>
                    {% endif %}
                </div>
            </div>

            <div class="tchiiz-nav-section">
                <div class="tchiiz-nav-item has-treeview" onclick="toggleSubmenu(this)">
                    <i class="fas fa-home"></i>
                    <span>{% translate "Homepage" %}</span>
                    <i class="fas fa-chevron-right tchiiz-submenu-arrow"></i>
                </div>
                <div class="tchiiz-nav-treeview">
                    {% if user.is_superuser %}
                        <a href="{% url 'administration:add_photos_homepage' %}"
                           class="tchiiz-nav-item {% if request.resolver_match.url_name == 'add_photos_homepage' %}active{% endif %}">
                            <i class="far fa-plus-square"></i>
                            <span>{% translate "Add photos" %}</span>
                        </a>
                    {% endif %}
                    <a href="{% url 'administration:list_photos_homepage' %}"
                       class="tchiiz-nav-item {% if request.resolver_match.url_name == 'list_photos_homepage' %}active{% endif %}">
                        <i class="far fa-copy"></i>
                        <span>{% translate "View all photos" %}</span>
                    </a>
                </div>
            </div>

            <div class="tchiiz-nav-section">
                <div class="tchiiz-nav-item has-treeview" onclick="toggleSubmenu(this)">
                    <i class="fas fa-image"></i>
                    <span>{% translate "Portfolio" %}</span>
                    <i class="fas fa-chevron-right tchiiz-submenu-arrow"></i>
                </div>
                <div class="tchiiz-nav-treeview">
                    {% if user.is_superuser %}
                        <a href="{% url 'administration:add_photos_portfolio' %}"
                           class="tchiiz-nav-item {% if request.resolver_match.url_name == 'add_photos_portfolio' %}active{% endif %}">
                            <i class="far fa-plus-square"></i>
                            <span>{% translate "Add photos" %}</span>
                        </a>
                    {% endif %}
                    <a href="{% url 'administration:list_photos_portfolio' %}"
                       class="tchiiz-nav-item {% if request.resolver_match.url_name == 'list_photos_portfolio' %}active{% endif %}">
                        <i class="far fa-file"></i>
                        <span>{% translate "View all photos" %}</span>
                    </a>
                    {% if user.is_superuser %}
                        <a href="{% url 'administration:add_album' %}"
                           class="tchiiz-nav-item {% if request.resolver_match.url_name == 'add_album' %}active{% endif %}">
                            <i class="far fa-edit"></i>
                            <span>{% translate "Create new album" %}</span>
                        </a>
                    {% endif %}
                </div>
            </div>

            <div class="tchiiz-nav-section">
                <div class="tchiiz-nav-item has-treeview" onclick="toggleSubmenu(this)">
                    <i class="fas fa-paper-plane"></i>
                    <span>{% translate "Send photo" %}</span>
                    <i class="fas fa-chevron-right tchiiz-submenu-arrow"></i>
                </div>
                <div class="tchiiz-nav-treeview">
                    <a href="{% url 'administration:send_photos_for_client_to_choose_from' %}"
                       class="tchiiz-nav-item {% if request.resolver_match.url_name == 'send_photos_for_client_to_choose_from' %}active{% endif %}">
                        <i class="fa fa-check-circle"></i>
                        <span>{% translate "To choose from" %}</span>
                    </a>
                    <a href="{% url 'administration:view_client_album_created' %}"
                       class="tchiiz-nav-item {% if request.resolver_match.url_name == 'view_client_album_created' %}active{% endif %}">
                        <i class="fa fa-heart"></i>
                        <span>{% translate "View all chosen" %}</span>
                    </a>
                    <a href="{% url 'administration:create_downloadable_file' %}"
                       class="tchiiz-nav-item {% if request.resolver_match.url_name == 'create_downloadable_file' %}active{% endif %}">
                        <i class="fa fa-chain"></i>
                        <span>{% translate "Final via link" %}</span>
                    </a>
                    <a href="{% url 'administration:show_all_links_created' %}"
                       class="tchiiz-nav-item {% if request.resolver_match.url_name == 'show_all_links_created' %}active{% endif %}">
                        <i class="far fa-eye"></i>
                        <span>{% translate "View all links" %}</span>
                    </a>
                    <a href="{% url 'administration:via_account' %}"
                       class="tchiiz-nav-item {% if request.resolver_match.url_name == 'via_account' %}active{% endif %}">
                        <i class="fa fa-user-plus"></i>
                        <span>{% translate "Final via account" %}</span>
                    </a>
                </div>
            </div>

            <div class="tchiiz-nav-divider"></div>

            <!-- Management Section -->
            <div class="tchiiz-nav-header">{% translate "Management" %}</div>

            <a href="{% url 'administration:user_list' %}"
               class="tchiiz-nav-item {% if request.resolver_match.url_name == 'user_list' %}active{% endif %}">
                <i class="fas fa-users"></i>
                <span>{% translate "Client management" %}</span>
            </a>

            <a href="{% url 'administration:message_list' %}"
               class="tchiiz-nav-item {% if request.resolver_match.url_name == 'message_list' %}active{% endif %}">
                <i class="fas fa-comment"></i>
                <span>{% translate "Message list" %}</span>
            </a>

            <a href="{% url 'administration:list_invoices' %}"
               class="tchiiz-nav-item {% if request.resolver_match.url_name == 'list_invoices' %}active{% endif %}">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>{% translate "Invoices" %}</span>
            </a>

            <div class="tchiiz-nav-divider"></div>

            <!-- System Section -->
            <div class="tchiiz-nav-header">{% translate "System" %}</div>

            <a href="{% url 'administration:help' %}"
               class="tchiiz-nav-item {% if request.resolver_match.url_name == 'help' %}active{% endif %}">
                <i class="fas fa-question-circle"></i>
                <span>{% translate "Help" %}</span>
            </a>

            <a href="{% url 'administration:must_change_password' user.id %}"
               class="tchiiz-nav-item {% if request.resolver_match.url_name == 'must_change_password' %}active{% endif %}">
                <i class="fas fa-key"></i>
                <span>{% translate "Change password" %}</span>
            </a>
        </nav>

        <!-- Footer -->
        <div class="tchiiz-sidebar-footer">
            <a href="{% url 'client:logout' %}" class="tchiiz-nav-item tchiiz-logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>{% translate "Sign out" %}</span>
            </a>
            <div class="tchiiz-footer-info">
                <span>v1.0.0</span> â€¢ <a href="{% url 'administration:help' %}">Support</a>
            </div>
        </div>
    </aside>

    <div class="tchiiz-main">
        <header class="tchiiz-header">
            <div class="tchiiz-header-left">
                <button class="tchiiz-mobile-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="tchiiz-breadcrumb">
                    <a href="{% url 'administration:index' %}" class="breadcrumb-home" title="Dashboard">
                        <i class="fas fa-home"></i>
                    </a>
                    <span class="separator">/</span>
                    <span class="current">{% block header_title %}Dashboard{% endblock %}</span>
                </div>
            </div>

            <div class="tchiiz-header-right">
                <!-- Notification Bell -->
                <div class="tchiiz-header-icon" title="Notifications">
                    <i class="far fa-bell"></i>
                    {% if total_contact_forms > 0 %}
                        <span class="tchiiz-notification-dot"></span>
                    {% endif %}
                </div>

                <!-- Language Switcher -->
                {% get_current_language as LANGUAGE_CODE %}
                <form action="{% url 'set_language' %}" method="post" class="tchiiz-lang-form">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ redirect_to }}">
                    <select name="language" onchange="this.form.submit()" class="tchiiz-lang-select">
                        {% get_available_languages as LANGUAGES %}
                        {% get_language_info_list for LANGUAGES as languages %}
                        {% for language in languages %}
                            <option value="{{ language.code }}"
                                    {% if language.code == LANGUAGE_CODE %}selected{% endif %}>
                                {{ language.code|upper }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </header>

        <div class="tchiiz-content">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            {% block body %}{% endblock %}
        </div>
    </div>

    <div class="tchiiz-overlay" onclick="toggleSidebar()"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Toggle Mobile Sidebar
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const body = document.body;
        sidebar.classList.toggle('open');
        body.classList.toggle('sidebar-open');
    }

    // Toggle Submenus - DON'T close others on desktop
    function toggleSubmenu(element) {
        const isOpen = element.classList.contains('menu-open');
        const isMobile = window.innerWidth <= 992;

        // Only close other submenus on mobile
        if (isMobile) {
            document.querySelectorAll('.tchiiz-nav-item.has-treeview').forEach(item => {
                if (item !== element) {
                    item.classList.remove('menu-open');
                    const submenu = item.nextElementSibling;
                    if (submenu) submenu.style.display = 'none';
                }
            });
        }

        // Toggle current submenu
        element.classList.toggle('menu-open');
        const submenu = element.nextElementSibling;
        if (submenu) {
            submenu.style.display = isOpen ? 'none' : 'block';
        }
    }

    // Toggle User Profile Stats
    function toggleUserProfile(element) {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('profile-expanded');
    }

    // Auto-open active menu on load - IMPROVED VERSION
    document.addEventListener('DOMContentLoaded', function () {
        // Look for ANY active nav item (not just in treeview)
        const activeItem = document.querySelector('.tchiiz-nav-item.active');

        if (activeItem) {
            // Check if this active item is inside a treeview (submenu)
            const parentTreeview = activeItem.closest('.tchiiz-nav-treeview');

            if (parentTreeview) {
                // Find the parent section containing this treeview
                const parentSection = parentTreeview.closest('.tchiiz-nav-section');

                if (parentSection) {
                    // Find the trigger button for this section
                    const trigger = parentSection.querySelector('.has-treeview');

                    if (trigger) {
                        // Open the submenu
                        trigger.classList.add('menu-open');
                        parentTreeview.style.display = 'block';

                        console.log('Auto-opened submenu for:', trigger.textContent.trim());
                    }
                }
            }
        }

        // Fallback: if no active item found, log it for debugging
        if (!activeItem) {
            console.warn('No active nav item found. Check if url_name matches in template.');
        }
    });
</script>

{% block customJS %}{% endblock %}
</body>
</html>
